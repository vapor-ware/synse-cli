version: 2
jobs:
  build:
    docker:
      - image: golang:latest
        environment:
          VAPOR_HOST: core.vapor.io
          DEBUG: true

    working_directory: /go/src/github.com/vapor-ware/synse-cli

    environment:
        TEST_DIRECTORY: "gotest"
        BINARY_NAME: "synse"

    steps:
      - checkout
      - run:
          name: "Installing Dependencies"
          command: go get -v
      - run:
          name: "Make test report directory"
          command: mkdir -p $CICLE_TEST_REPORTS/$TEST_DIRECTORY
      - run:
          name: "Get test to junit xml parser"
          command: go get -v -u github.com/jstemmer/go-junit-report
      - run:
          name: "Running Tests"
          command: go test -v --race ./...
      - run:
          name: "Getting builder"
          command: |
            go get -v github.com/mitchellh/gox
            go get -v github.com/tcnksm/ghr
      - run:
          name: "Building"
          command: gox --output="build/$BINARY_NAME_{{.OS}}_{{.Arch}}" -os='!windows' -osarch='!darwin/386'
      - store_artifacts:
          path: build
          destination: build
